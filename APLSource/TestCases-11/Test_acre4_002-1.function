 R←Test_acre4_002(stopFlag batchFlag);n;n2;oldPath;⎕TRAP;openAcreProjects;acreTestProjectName;changeFilesFolder;acreTestProjectFolder
⍝ Check whether acre 4 reacts correctly when an object is deleted by Fire and there are self-refs around.
 ⎕TRAP←(999 'C' '. ⍝ Deliberate error')(0 'N')

 :If IsAcre2Or3
     →0,R←∆Inactive
 :EndIf

 R←∆Failed

⍝ Preconditions
 #.⎕EX'FireAcreTest'
 'FireAcreTest'#.⎕NS''

 #.FireAcreTest.selfRef←#.FireAcreTest
 'FireAcreTest.Level2'#.⎕NS''
 'FireAcreTest.Level2.Level3'#.⎕NS''
 #.FireAcreTest.Level2.Level3.ref←#.FireAcreTest

 #.FireAcreTest.⎕FX'r←Doe' 'r←''Johnny ''' 'r,←''in the world'''
 #.FireAcreTest.⎕FX'r←Foe' 'r←''Anna ''' 'r,←''in the world'''
 #.FireAcreTest.⎕FIX':Class Foo' '∇r←Hello' ':Access Public Shared' 'r←''World''' '∇' ':EndClass'
 #.FireAcreTest.ref←⎕NS''
 #.FireAcreTest.ref2←#.FireAcreTest.⎕NS''
 #.FireAcreTest.ref.⎕FX'r←DeleteMe' 'r←''This is DeleteMe''' '⍝world'
 #.FireAcreTest.⎕FIX':Class MyClass' '∇Hello' 'r←''world''' '∇' '∇co' ':Access Public' 'Implements constructor' '∇' ':EndClass'
 #.FireAcreTest.⎕FIX':Namespace MyNamespace' '∇HelloNS' 'r←''world''' '∇' ':EndNamespace'
 'MyForm'#.FireAcreTest.⎕WC' Form'('Visible' 0)('KeepOnClose' 1)
 #.FireAcreTest.MyForm.⎕FX'r←Universe' 'r←''Includes world'''
 {}#.FireAcreTest.⎕NEW #.FireAcreTest.MyClass
 acreTestProjectName←'FireAcreTestTemp'
 #.FilesAndDirs.RmDir'..\',acreTestProjectName
 {}⎕SE.UCMD'acre.CreateProject ',acreTestProjectName,' #.FireAcreTest'

 1 #._Fire.Fire.Run 0
 n←#._Fire.Fire.GUI.n
 ∆InitialyzeFireMainGUI_Settings n

 n.SearchFor.Text←'world'
 n.LookIn.Text←'#.FireAcreTest'

 n.Negate.State←0
 n.ReuseSearch.State←0

 {}∆Select n.StartBtn
 ∆Process n.Form
 →GoToTidyUp 6≠#._Fire.Fire.G.NoOfObjects

 n.HitList.SelItems←n.HitList.Items∊'Doe' 'Foe'
 {}#._Fire.Fire.GUI.LetAcreDelete n.HitList.Items⍳'Doe' 'Foe'
 1 ∆Process n.Form

 →GoToTidyUp~∧/~'Doe' 'Foe'∊#.FireAcreTest.⎕NL-⍳16
 changeFilesFolder←'expand'#.FilesAndDirs.NormalizePath acreTestProjectName,'\.acre\changes\'
 →GoToTidyUp~'delete' 'delete'≡#.APLTreeUtils.Last¨↑#.FilesAndDirs.Dir changeFilesFolder
 R←∆OK

∆TidyUp:
 #.⎕EX'FireAcreTest'
 #.FilesAndDirs.RmDir acreTestProjectName
 CloseFire
